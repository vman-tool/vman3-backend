worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;

    keepalive_timeout 65;
    client_max_body_size 100M;

    # Docker embedded DNS (VERY IMPORTANT)
    resolver 127.0.0.11 valid=10s ipv6=off;

    # =========================
    # UPSTREAMS (LOAD BALANCED)
    # =========================

    upstream frontend_upstream {
        zone frontend 64k;
        server frontend:4200 resolve;
    }

    upstream backend_upstream {
        zone backend 64k;
        least_conn;
        server backend:8080 resolve;
    }

    upstream arango_upstream {
        zone arango 64k;
        server arango-db:8529 resolve;
    }

    # Flower - Celery monitoring UI
    upstream flower_upstream {
        zone flower 64k;
        server flower:5555 resolve;
    }

    # =========================
    # SERVER
    # =========================
    server {
        listen 80;
        server_name vman3.vatools.net www.vman3.vatools.net localhost;

        # ----------------------
        # Health check
        # ----------------------
        location /nginx-health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # ----------------------
        # Frontend (Angular)
        # ----------------------
        location / {
            proxy_pass http://frontend_upstream;
            proxy_http_version 1.1;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_connect_timeout 5s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;

            # Buffers
            proxy_buffer_size 128k;
            proxy_buffers 8 128k;
            proxy_busy_buffers_size 256k;
            
            # CORS Headers
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods 'GET, POST, PUT, DELETE, OPTIONS';
            add_header Access-Control-Allow-Headers 'Origin, Content-Type, Accept, Authorization';
        }

        # ----------------------
        # Backend API
        # ----------------------
        location /vman/api/v1 {
            proxy_pass http://backend_upstream;
            proxy_http_version 1.1;

            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Specific headers for backend
            proxy_set_header Content-Security-Policy "upgrade-insecure-requests";

            proxy_connect_timeout 10s;
            proxy_send_timeout 86400s;
            proxy_read_timeout 86400s;

            # Buffers
            proxy_buffer_size 128k;
            proxy_buffers 8 128k;
            proxy_busy_buffers_size 256k;
        }

        # ----------------------
        # WebSocket (FastAPI)
        # ----------------------
        location /vman/api/v1/ws {
            proxy_pass http://backend_upstream;
            proxy_http_version 1.1;

            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_read_timeout 86400s;
            proxy_send_timeout 86400s;
        }

        # ----------------------
        # Uploads (Backend)
        # ----------------------
        location /uploads {
            proxy_pass http://backend_upstream;
            proxy_http_version 1.1;

            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_connect_timeout 10s;
            proxy_read_timeout 86400s;
            proxy_send_timeout 86400s;
        }

        # ----------------------
        # ArangoDB
        # ----------------------
        location /_db {
            proxy_pass http://arango_upstream;
            proxy_redirect off;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_set_header Content-Security-Policy "upgrade-insecure-requests";
            proxy_buffer_size 128k;
            proxy_buffers 8 128k;
            proxy_busy_buffers_size 256k;
        }

        location /db {
            proxy_pass http://arango_upstream/; 
        }

        # ----------------------
        # Flower (Celery Monitoring) - Protected with Basic Auth
        # ----------------------
        location /flower {
            # Basic Authentication - generate with: htpasswd -c /etc/nginx/.htpasswd admin
            auth_basic "Celery Monitoring";
            auth_basic_user_file /etc/nginx/.htpasswd;

            proxy_pass http://flower_upstream;
            proxy_http_version 1.1;

            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_redirect off;
            rewrite ^/flower/(.*)$ /$1 break;
        }
    }
}